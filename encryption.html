<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="Logo.png" type="image/x-icon" alt="DataFortress">
    <link rel="stylesheet" href="encryption.css">
    <title>DataFortress</title>
</head>

<body>
    <nav>
        <a href="user_landingpage.html"><img src="Logo.png" alt="DataFortress Logo"></a>
        <ul>
            <li class="home"><a href="user_landingpage.html">Home</a></li>
            <li class="logout"><a href="index.html">Logout</a></li>
        </ul>
    </nav>
    <br>

    <div class="tabs">
        <button class="tab-button active">Encrypt Tool</button>
        <button class="tab-button"><a href="decryption.html">Decrypt Tool</a></button>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="file-upload">
                <div class="file-name">No file chosen</div>
                <label for="fileInput" class="choose-file-button">Choose File</label>
                <input type="file" id="fileInput" style="display: none;">
            </div>
    
            <div class="passkey-input">
                <div class="copy-icon-container">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
                    </svg>
                </div>
                <input type="text" id="passkey" placeholder="Passkey" readonly>
                <button class="create-passkey-button">Create Passkey</button>
                <div class="info-passkey-container">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                    </svg>
                    <span class="tooltip-text"><b>Please remember your passkey.</b> DataFortress puts you in control of your security and doesn't store your files or passkeys.</span>
                </div>
            </div>
            <button class="encrypt-button">Encrypt</button>

            <div class="download-window" id="download">
                <div class="download-content">
                    <button id="close-window">X</button><br>
                    <h2>Encrypted File is Ready!</h2>
                    <button class="download-button" id = "initiateDownload">Download</button>
                    <span class="download-timer"></span>
                    <span class="download-reminder">For your security, DataFortress only allows a 5-minute window to download your file. <br> Make sure to grab it before time runs out!</span>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
            <p>&copy; 2025 DataFortress. All rights reserved.</p>
    </footer>

    <script>
        // Add this function after the variable declarations at the start of the script
async function encryptFile(file, passkey) {
    try {
        // Convert passkey to cryptographic key
        const encoder = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
            "raw",
            encoder.encode(passkey),
            "PBKDF2",
            false,
            ["deriveBits", "deriveKey"]
        );

        // Generate salt
        const salt = window.crypto.getRandomValues(new Uint8Array(16));
        
        // Derive key
        const key = await window.crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt: salt,
                iterations: 100000,
                hash: "SHA-256"
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt"]
        );

        // Generate IV
        const iv = window.crypto.getRandomValues(new Uint8Array(12));

        // Read file as ArrayBuffer
        const fileBuffer = await file.arrayBuffer();

        // Encrypt the file
        const encryptedContent = await window.crypto.subtle.encrypt(
            {
                name: "AES-GCM",
                iv: iv
            },
            key,
            fileBuffer
        );

        // Combine salt, iv, and encrypted content
        const combinedArray = new Uint8Array(salt.length + iv.length + encryptedContent.byteLength);
        combinedArray.set(salt, 0);
        combinedArray.set(iv, salt.length);
        combinedArray.set(new Uint8Array(encryptedContent), salt.length + iv.length);

        return new Blob([combinedArray], { type: 'application/octet-stream' });
    } catch (error) {
        console.error('Encryption error:', error);
        throw error;
    }
}

// Add this to the script section
async function generateSecurePasskey() {
    const array = new Uint8Array(12);
    window.crypto.getRandomValues(array);
    return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
}
        
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.querySelector('.file-name');
        const createPasskeyButton = document.querySelector('.create-passkey-button');
        const passkeyInput = document.getElementById('passkey');
        const copyIconContainer = document.querySelector('.copy-icon-container');
        const encryptButton = document.querySelector('.encrypt-button');
        const downloadWindow = document.getElementById('download');
        const closeDownloadWindow = document.getElementById('close-window');
        const initiateDownloadButton = document.getElementById('initiateDownload');
        const timerDisplayElement = document.querySelector('.download-timer');

        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileNameDisplay.textContent = this.files[0].name;
            } else {
                fileNameDisplay.textContent = 'No file chosen';
            }
        });

// Update the createPasskeyButton click handler
    createPasskeyButton.addEventListener('click', async function() {
    const generatedPasskey = await generateSecurePasskey();
    passkeyInput.value = generatedPasskey;
});

        copyIconContainer.addEventListener('click', function() {
            if (passkeyInput.value) {
                passkeyInput.select();
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                alert('Passkey copied to clipboard!');
            } else {
                alert('No passkey to copy.');
            }
        });

        let timeLeft = 120;  // Reset time left to 2 minutes (120 seconds)
        let timerInterval;

        function updateTimer() {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplayElement.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;


            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                downloadWindow.style.display = 'none';
                alert("Download time expired!");
            }
        }
// Update the encryptButton click handler
encryptButton.addEventListener('click', async function() {
    const file = fileInput.files[0];
    const passkey = passkeyInput.value;

    if (!file || !passkey) {
        alert('Please choose a file and generate a passkey.');
        return;
    }

    if (file.size > 10 * 1024 * 1024) {
        alert('File size exceeds the 10 MB limit.');
        return;
    }

    downloadWindow.style.display = 'flex';
    timeLeft = 300;
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
});

        closeDownloadWindow.addEventListener('click', () => {
            downloadWindow.style.display = 'none';
            clearInterval(timerInterval);
        });

// Replace the initiateDownloadButton click event handler with this:
initiateDownloadButton.addEventListener('click', async function() {
    const file = fileInput.files[0];
    const passkey = passkeyInput.value;

    if (file && passkey) {
        try {
            const encryptedBlob = await encryptFile(file, passkey);
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(encryptedBlob);
            downloadLink.download = file.name + '.encrypted';
            downloadLink.click();
            downloadWindow.style.display = 'none';
            clearInterval(timerInterval);
        } catch (error) {
            alert('Encryption failed. Please try again.');
            console.error(error);
        }
    } else {
        alert('Please choose a file and create a passkey before downloading.');
    }
});
    </script>
</body>

</html>
